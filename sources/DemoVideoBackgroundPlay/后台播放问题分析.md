# iOS è§†é¢‘åå°æ’­æ”¾é—®é¢˜ç³»ç»Ÿåˆ†æ

## å½“å‰å®ç°çŠ¶æ€æ£€æŸ¥

### âœ… å·²å®ç°çš„éƒ¨åˆ†

1. **é¡¹ç›®é…ç½®**
   - âœ… `INFOPLIST_KEY_UIBackgroundModes = audio` å·²é…ç½®

2. **éŸ³é¢‘ä¼šè¯**
   - âœ… è®¾ç½® `.playback` ç±»åˆ«
   - âœ… è®¾ç½® `.moviePlayback` æ¨¡å¼
   - âš ï¸ ä½¿ç”¨ `.mixWithOthers` é€‰é¡¹ï¼ˆå¯èƒ½æ˜¯é—®é¢˜ï¼‰
   - âœ… åœ¨ App å¯åŠ¨æ—¶é…ç½®
   - âœ… åœ¨ PlayerManager ä¸­é…ç½®
   - âœ… è¿›å…¥åå°æ—¶é‡æ–°æ¿€æ´»

3. **AVPlayer é…ç½®**
   - âœ… ä½¿ç”¨ AVPlayerViewController
   - âœ… allowsExternalPlayback = true
   - âœ… automaticallyWaitsToMinimizeStalling = false

4. **Now Playing & è¿œç¨‹æ§åˆ¶**
   - âœ… é…ç½® MPNowPlayingInfoCenter
   - âœ… é…ç½® MPRemoteCommandCenter
   - âœ… å®šæ—¶æ›´æ–°æ’­æ”¾è¿›åº¦

5. **ç”Ÿå‘½å‘¨æœŸå¤„ç†**
   - âœ… ç›‘å¬ UIApplication.didEnterBackgroundNotification
   - âœ… ç›‘å¬éŸ³é¢‘ä¸­æ–­é€šçŸ¥
   - âœ… åå°æ—¶å°è¯•ç»§ç»­æ’­æ”¾

### âŒ å¯èƒ½çš„é—®é¢˜ç‚¹

1. **`.mixWithOthers` é€‰é¡¹**
   - è¿™ä¸ªé€‰é¡¹å‘Šè¯‰ç³»ç»Ÿä½ çš„éŸ³é¢‘å¯ä»¥ä¸å…¶ä»–éŸ³é¢‘æ··åˆ
   - ç³»ç»Ÿå¯èƒ½è®¤ä¸ºè¿™ä¸æ˜¯ä¸»è¦éŸ³é¢‘æºï¼Œä»è€Œåœ¨åå°åœæ­¢
   - **å»ºè®®**ï¼šç§»é™¤æ­¤é€‰é¡¹

2. **AVPlayerViewController é…ç½®ç¼ºå¤±**
   - æœªè®¾ç½® `updatesNowPlayingInfoCenter`
   - æœªè®¾ç½® `canStartPictureInPictureAutomaticallyFromInline`

3. **è§†é¢‘æºé—®é¢˜**
   - Big Buck Bunny è§†é¢‘å¯èƒ½æ²¡æœ‰éŸ³é¢‘è½¨é“
   - æˆ–éŸ³é¢‘è½¨é“æ ¼å¼ä¸æ”¯æŒ

4. **æ—¶åºé—®é¢˜**
   - éŸ³é¢‘ä¼šè¯é…ç½®å’Œæ’­æ”¾å™¨åˆ›å»ºçš„æ—¶åºå¯èƒ½æœ‰é—®é¢˜

## ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç§»é™¤ mixWithOthers
```swift
// å°†
try audioSession.setCategory(.playback, mode: .moviePlayback, options: [.mixWithOthers])
// æ”¹ä¸º
try audioSession.setCategory(.playback, mode: .moviePlayback, options: [])
```

### æ–¹æ¡ˆ2ï¼šå¢å¼º AVPlayerViewController é…ç½®
```swift
controller.updatesNowPlayingInfoCenter = false  // æˆ‘ä»¬æ‰‹åŠ¨ç®¡ç†
controller.entersFullScreenWhenPlaybackBegins = false
```

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨ä¸åŒçš„æµ‹è¯•è§†é¢‘
```swift
// ä½¿ç”¨ Apple çš„æµ‹è¯•æµï¼Œç¡®ä¿æœ‰éŸ³é¢‘
private let videoURL = URL(string: "https://devstreaming-cdn.apple.com/videos/streaming/examples/bipbop_adv_example_hevc/master.m3u8")!
```

### æ–¹æ¡ˆ4ï¼šæ·»åŠ è°ƒè¯•ä¿¡æ¯
æ£€æŸ¥è§†é¢‘æ˜¯å¦æœ‰éŸ³é¢‘è½¨é“ï¼š
```swift
if let tracks = playerItem?.asset.tracks(withMediaType: .audio) {
    print("éŸ³é¢‘è½¨é“æ•°é‡: \(tracks.count)")
}
```

## æµ‹è¯•æ­¥éª¤

1. **åŸºç¡€æµ‹è¯•**
   - å¯åŠ¨åº”ç”¨ï¼Œç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆ
   - æ’­æ”¾ 5-10 ç§’ï¼ˆç¡®ä¿ç¼“å†²å……è¶³ï¼‰
   - æŒ‰ Home é”®
   - æ£€æŸ¥æ˜¯å¦ç»§ç»­æ’­æ”¾

2. **æ§åˆ¶ä¸­å¿ƒæµ‹è¯•**
   - åå°æ’­æ”¾æ—¶æ‰“å¼€æ§åˆ¶ä¸­å¿ƒ
   - æ˜¯å¦æ˜¾ç¤ºæ’­æ”¾æ§ä»¶ï¼Ÿ
   - èƒ½å¦æš‚åœ/æ¢å¤ï¼Ÿ

3. **é”å±æµ‹è¯•**
   - é”å®šè®¾å¤‡
   - æ˜¯å¦æ˜¾ç¤º Now Playing ä¿¡æ¯ï¼Ÿ
   - èƒ½å¦æ§åˆ¶æ’­æ”¾ï¼Ÿ

## æ—¥å¿—æ£€æŸ¥ç‚¹

å…³é”®æ—¥å¿—ï¼š
- `âœ… App éŸ³é¢‘ä¼šè¯é…ç½®æˆåŠŸ`
- `âœ… éŸ³é¢‘ä¼šè¯é…ç½®æˆåŠŸ`
- `â–¶ï¸ æ’­æ”¾å™¨å¼€å§‹æ’­æ”¾ï¼Œrate: 1.0`
- `ğŸ“± åº”ç”¨è¿›å…¥åå°ï¼Œç¡®ä¿æ’­æ”¾ç»§ç»­`
- `åå°æ’­æ”¾æ£€æŸ¥ - rate:` ï¼ˆåº”è¯¥æ˜¯ 1.0ï¼‰

é”™è¯¯æ ‡å¿—ï¼š
- `PlayerRemoteXPC err=-12860` - éŸ³é¢‘ä¼šè¯æœªæ¿€æ´»
- `rate: 0.0` - æ’­æ”¾å™¨è¢«æš‚åœ

## ç»ˆæè§£å†³æ–¹æ¡ˆ

å¦‚æœä»¥ä¸Šéƒ½ä¸è¡Œï¼Œå¯èƒ½éœ€è¦ï¼š

1. **ä½¿ç”¨ AVQueuePlayer** ä»£æ›¿ AVPlayer
2. **å®ç°åå°ä»»åŠ¡**ï¼š
   ```swift
   var backgroundTask: UIBackgroundTaskIdentifier = .invalid
   
   func startBackgroundTask() {
       backgroundTask = UIApplication.shared.beginBackgroundTask {
           UIApplication.shared.endBackgroundTask(self.backgroundTask)
       }
   }
   ```

3. **è€ƒè™‘ä½¿ç”¨ç”»ä¸­ç”»ï¼ˆPiPï¼‰** ä½œä¸ºåå°æ’­æ”¾çš„æ›¿ä»£æ–¹æ¡ˆ

## è®¾å¤‡ç›¸å…³å› ç´ 

- iOS ç‰ˆæœ¬ï¼ˆå»ºè®® iOS 14+ï¼‰
- ä½ç”µé‡æ¨¡å¼æ˜¯å¦å¼€å¯
- é™éŸ³å¼€å…³çŠ¶æ€
- å…¶ä»–åº”ç”¨æ˜¯å¦åœ¨æ’­æ”¾éŸ³é¢‘

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. é¦–å…ˆç§»é™¤ `.mixWithOthers`
2. ä½¿ç”¨ Apple çš„æµ‹è¯•è§†é¢‘
3. æ·»åŠ éŸ³é¢‘è½¨é“æ£€æŸ¥
4. åœ¨çœŸæœºä¸Šæµ‹è¯•ï¼ˆiPhoneï¼Œéæ¨¡æ‹Ÿå™¨ï¼‰
