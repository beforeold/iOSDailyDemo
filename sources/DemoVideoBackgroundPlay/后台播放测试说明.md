# 后台播放测试说明

## 当前实现

### 1. 关键配置
- ✅ 项目配置中已添加 `INFOPLIST_KEY_UIBackgroundModes = audio`
- ✅ 使用 `AVPlayerViewController` 而非 SwiftUI `VideoPlayer`
- ✅ 音频会话配置为 `.playback` 类别
- ✅ 监听应用生命周期并在后台重新激活音频会话

### 2. 测试步骤

1. **在真机上测试（推荐）**
   - 后台播放功能在模拟器上可能表现不一致
   - 使用真实 iPhone 设备进行测试

2. **运行应用**
   - 启动应用，视频应自动开始播放
   - 查看控制台日志：
     ```
     ✅ App 音频会话配置成功，支持后台播放
     ✅ 音频会话配置成功，支持后台播放
     🎬 开始创建播放器，URL: ...
     ▶️ 播放器开始播放，rate: 1.0
     ```

3. **测试后台播放**
   - 等待视频播放几秒钟
   - 按 Home 键或切换到其他应用
   - 查看控制台日志：
     ```
     📱 应用进入后台，确保播放继续
        当前播放状态 - rate: 1.0
        ✅ 音频会话已激活
        播放器正在播放
        后台播放检查 - rate: 1.0
     ```
   - 应该能听到视频的音频继续播放

4. **检查控制中心**
   - 从屏幕底部上滑（或从右上角下拉）打开控制中心
   - 应该能看到正在播放的媒体控件
   - 可以通过控制中心暂停/播放

### 3. 可能的问题

#### 问题 1：rate 为 0（播放器已暂停）
- 如果日志显示 `rate: 0.0`，说明播放器被暂停了
- 检查视频 URL 是否可访问
- 确保视频文件有音频轨道

#### 问题 2：音频会话激活失败
- 检查是否有其他应用占用音频会话
- 尝试重启设备

#### 问题 3：在模拟器上无法后台播放
- 这是正常的，模拟器对后台播放的支持有限
- 请使用真机测试

### 4. 调试技巧

查看完整的控制台日志：
```bash
# 在 Xcode 中查看控制台
# 或使用命令行工具
xcrun simctl spawn booted log stream --predicate 'processImagePath contains "DemoVideoBackgroundPlay"' --level=debug
```

关键日志标记：
- 🎬 播放器创建
- ▶️ 开始播放
- 📱 应用生命周期
- ✅ 成功
- ❌ 失败

### 5. 其他注意事项

1. **iOS 设置**
   - 确保设备的"低电量模式"未开启
   - 确保应用的"后台应用刷新"权限已开启

2. **视频要求**
   - 视频必须有音频轨道才能在后台播放
   - 纯视频（无音频）无法在后台继续

3. **网络视频**
   - 如果使用网络视频，确保网络连接正常
   - HTTPS URL 更可靠

## 如果仍然无法工作

请提供以下信息：
1. 控制台的完整日志
2. 测试设备信息（真机/模拟器，iOS 版本）
3. 视频 URL
4. 具体现象（是完全没有声音，还是播放一会儿就停止了）

